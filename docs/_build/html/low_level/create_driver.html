

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Write your own Driver &mdash; Autolab  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="author" title="About these documents" href="../about.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Devices (High-level interface)" href="../high_level.html" />
    <link rel="prev" title="Load and use a Driver" href="open_and_use.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Autolab
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Drivers (Low-level interface)</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="open_and_use.html">Load and use a Driver</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Write your own Driver</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#getting-started-create-a-new-driver">Getting started: create a new driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="#driver-structure-manufacturer-model-py-file">Driver structure (<em>&lt;manufacturer&gt;_&lt;MODEL&gt;.py</em> file)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#import-modules-optionnal">1 -  import modules (optionnal)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#class-driver-connection">3 -  class Driver_CONNECTION</a></li>
<li class="toctree-l4"><a class="reference internal" href="#class-driver">2 -  class Driver</a></li>
<li class="toctree-l4"><a class="reference internal" href="#additional-class-optionnal">4 -  Additional class (optionnal)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#additional-necessary-functions-files">Additional necessary functions/files</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#function-get-driver-model-in-each-class-but-driver-connection">Function get_driver_model (in each class but Driver_CONNECTION)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#driver-utilities-structure-manufacturer-model-utilities-py-file">Driver utilities structure (<em>&lt;manufacturer&gt;_&lt;MODEL&gt;_utilities.py</em> file)</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../high_level.html">Devices (High-level interface)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../local_config.html">Local configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gui/index.html">Graphical User Interface (GUI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../shell/index.html">OS shell</a></li>
<li class="toctree-l1"><a class="reference internal" href="../help_report.html">Docs and bugs/suggestions report</a></li>
<li class="toctree-l1"><a class="reference internal" href="../releases_notes.html">Releases notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../about.html">About</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Autolab</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Drivers (Low-level interface)</a> &raquo;</li>
        
      <li>Write your own Driver</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/low_level/create_driver.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="write-your-own-driver">
<span id="create-driver"></span><h1>Write your own Driver<a class="headerlink" href="#write-your-own-driver" title="Permalink to this headline">¶</a></h1>
<p>The goal of this tutorial is to present the general structure of the drivers of this package, in order for you to create simply your own drivers, and make them available to the community within this collaborative project. We notably provide a fairly understandable driver structure that can handle the highest degree of instruments complexity (including: single and multi-channels function generators, oscilloscopes, Electrical/Optical frames with associated interchangeable submodules, etc.). This provides reliable ways to add other types of connection to your driver (e.g. GPIB to Ethenet) or other functions (e.g. get_amplitude, set_frequency, etc.).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To help you with writting your own drivers a few templates are provided on the <a class="reference external" href="https://github.com/qcha41/autolab/tree/master/autolab/drivers/More/Templates">GitHub page of the project</a>.</p>
</div>
<p>We will first discuss the generalities to create a new driver or modify an existing one and share it with the community in <strong>getting started: create a new driver</strong>, that will particularly describe the required convention (location, files and namings) as well as the actual way to share it with the community (addition to the main package), and finally we will detail the typical <strong>driver structure</strong> as well as the required homogeneities. Those last will ensure that all the features of the drivers you would add are best used by autolab’s utilities (helps, gui, parser, etc.).</p>
<div class="section" id="getting-started-create-a-new-driver">
<h2>Getting started: create a new driver<a class="headerlink" href="#getting-started-create-a-new-driver" title="Permalink to this headline">¶</a></h2>
<p><strong>To develop your own drivers</strong>, autolab provide you with a directory named local_drivers (located at ~/autolab/local_drivers, where ~ represents the user root) created when the package is installed. This directory is inspected by autolab to search for locally defined drivers. This way you may modify existing drivers (addition of new functions, etc.) or create new drivers to drive new instruments not yet supported by autolab.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Each driver name should be unique: do not define new drivers (in your local folders) with a name that already exists in the main package.</p>
</div>
<p>In the local_drivers directory, as in the main package, each instrument has/should have its own directory organized and named as follow. The name of this folder take the form <em>&lt;manufacturer&gt;_&lt;MODEL&gt;</em>. The driver associated to this instrument is a python script taking the same name as the folder: <em>&lt;manufacturer&gt;_&lt;MODEL&gt;.py</em>. A second python script, allowing the parser to work properly, should be named <em>&lt;manufacturer&gt;_&lt;MODEL&gt;_utilities.py</em> (<a class="reference external" href="https://github.com/qcha41/autolab/tree/master/autolab/drivers/More/Templates">find a minimal template here</a>). Additional python scripts may be present in this folder (devices’s modules, etc.). Please see the existing drivers of the autolab package for extensive examples.</p>
<p><strong>For addition to the main package</strong>: Once you tested your driver and it is ready to be used by others, you can send the appropriate directory to the contacts (<a class="reference internal" href="../about.html#about"><span class="std std-ref">About</span></a>).</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><strong>General note</strong></p>
<ul class="simple">
<li><p>The imports of additional modules (numpy, pandas, time, etc.) should be made in the class they are needed so that the imports are done only if needed (e.g. import visa within the Driver_VISA class).</p></li>
</ul>
</div>
</div>
<div class="section" id="driver-structure-manufacturer-model-py-file">
<h2>Driver structure (<em>&lt;manufacturer&gt;_&lt;MODEL&gt;.py</em> file)<a class="headerlink" href="#driver-structure-manufacturer-model-py-file" title="Permalink to this headline">¶</a></h2>
<p>The Driver is organized in several <a class="reference external" href="https://docs.python.org/tutorial/classes.html">python class</a> with a structure as follow. The numbers represent the way sections appear from the top to the bottom of an actual driver file. We chose to present the sections in a different way:</p>
<div class="section" id="import-modules-optionnal">
<h3>1 -  import modules (optionnal)<a class="headerlink" href="#import-modules-optionnal" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>To import possible additional modules, e.g.:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">zeros</span><span class="p">,</span><span class="n">ones</span><span class="p">,</span><span class="n">linspace</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="class-driver-connection">
<h3>3 -  class Driver_CONNECTION<a class="headerlink" href="#class-driver-connection" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>The class Driver_CONNECTION: <strong>establish the connection with the instrument</strong> and <strong>define the communication functions</strong>.</p>
<p>As a reminder, a communication with an instruments occurs in general with strings that are set by the manufacturer and instrument and model dependent. To receive and send strings from and to the instrument we first need to establish a connection. This will be done using dedicated python package such as <cite>pyvisa</cite>, <cite>pyserial</cite>, <cite>socket</cite> and physical connections such as Ethernet, GPIB, or USB. See bellow for an example help with using a VISA type of connection.</p>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<p>The connection types are refered to with capital characters in the classes names, e.g.:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Driver_SOCKET</span><span class="p">():</span>
<span class="k">class</span> <span class="nc">Driver_TELNET</span><span class="p">():</span>
</pre></div>
</div>
</div>
<p>When using the driver module (.py) the Driver_CONNECTION class is imported as the top layer, it inherits all the attributes of the Driver class and run its <code class="docutils literal notranslate"><span class="pre">__init__</span></code> function. It is the class that is used. Note that the connection classes are located, within a driver module, bellow the Driver class, because they use it before reaching their own <code class="docutils literal notranslate"><span class="pre">__init__</span></code> function.</p>
<p>Here is a commented example of the Driver_CONNECTION class, further explained bellow:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#################################################################################</span>
<span class="c1">############################## Connections classes ##############################</span>
<span class="k">class</span> <span class="nc">Driver_VISA</span><span class="p">(</span><span class="n">Driver</span><span class="p">):</span>           <span class="c1"># Inherits all the attributes of the class Driver</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="s1">&#39;GPIB0::2::INSTR&#39;</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>  <span class="c1"># 0) Definition of the ``__init__`` function</span>
        <span class="kn">import</span> <span class="nn">visa</span>                  <span class="c1"># 1) Connection library to use</span>

        <span class="n">rm</span> <span class="o">=</span> <span class="n">visa</span><span class="o">.</span><span class="n">ResourceManager</span><span class="p">()</span>  <span class="c1"># Use of visa&#39;s ressource manager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inst</span> <span class="o">=</span> <span class="n">rm</span><span class="o">.</span><span class="n">get_instrument</span><span class="p">(</span><span class="n">address</span><span class="p">)</span> <span class="c1"># 2) Establish the communication with the instrument</span>

        <span class="n">Driver</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>        <span class="c1"># 3) Run what is define in the Driver.__init__ function</span>

    <span class="c1"># Communication functions</span>
    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">command</span><span class="p">):</span>         <span class="c1"># 4) Defines a write function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>     <span class="c1"># Sends a string &#39;command&#39; to the instrument</span>
    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>                  <span class="c1"># 5) Defines a read function</span>
        <span class="n">rep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inst</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>       <span class="c1"># Receives a string &#39;rep&#39; from the instrument and return it</span>
        <span class="k">return</span> <span class="n">rep</span>
    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">query</span><span class="p">):</span>           <span class="c1"># 6) Defines a query function: combine your own write and read functions to send a string and ask for an answer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>                 <span class="c1"># 7) Closes the communication</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inst</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="c1">############################## Connections classes ##############################</span>
<span class="c1">#################################################################################</span>
</pre></div>
</div>
<p>In this case the Driver_CONNECTION class is called <code class="docutils literal notranslate"><span class="pre">Driver_VISA</span></code>. To use a driver we usually create an instance of the Driver_CONNECTION class (cf. <a class="reference internal" href="open_and_use.html#userguide-low"><span class="std std-ref">Load and use a Driver</span></a>):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">Instance</span> <span class="o">=</span> <span class="n">Driver_VISA</span><span class="p">(</span><span class="n">address</span><span class="o">=</span><span class="s1">&#39;GPIB0::3::INSTR&#39;</span><span class="p">)</span>   <span class="c1"># Use the given `visa` address (i.e., GPIB address 3 and board_index 0)</span>
</pre></div>
</div>
<dl>
<dt>This execute the <code class="docutils literal notranslate"><span class="pre">__init__</span></code> function that (following this example labels):</dt><dd><p>1) import the connection type library</p>
<p>2) load the instrument (using its address and eventual other arguments)</p>
<p>3) run the Driver.__init__ (for everything not related with the connection to the instrument, detailed in the Driver class section)</p>
</dd>
</dl>
<p>In general, the <code class="docutils literal notranslate"><span class="pre">__init__</span></code> function should establish the connection and store the instrument Instance in a class attribute (here: <code class="docutils literal notranslate"><span class="pre">self.inst</span></code>). (The communication functions that follow will use this attribute.)</p>
<p>Importantly, the communication functions are (re-)defined in this class including write [4)], read [5)], query [6)] and close [7)] functions that are the bare minimum. They are the ones that must be used in all the other classes (Driver, Module_, etc.). They must take <strong>a string as argument</strong> and <strong>return a string</strong>, <strong>without any termination character</strong> (e.g. <code class="docutils literal notranslate"><span class="pre">\n</span></code>, <code class="docutils literal notranslate"><span class="pre">\r</span></code>, etc.). This way several connection classes can coexist and use the same other classes allowing different possible physical connections and in general more flexibility.</p>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<p>Several points are worth noting:</p>
<blockquote>
<div><ul>
<li><p>0) The <code class="docutils literal notranslate"><span class="pre">__init__</span></code> function definition should explicitely contain all the arguments that are necessary to establish the communication (in this exemple <code class="docutils literal notranslate"><span class="pre">address</span></code>) along with a default value (for example the one that works for you), in order for the automatic autolab help to behave properly. The <code class="docutils literal notranslate"><span class="pre">__init__</span></code> function definition should also have an extra argument <code class="docutils literal notranslate"><span class="pre">**kwargs</span></code> allowing to accept and possibly pass any extra argument provided.</p></li>
<li><p>3) For more complicated instruments an additional argument <code class="docutils literal notranslate"><span class="pre">**kwargs</span></code> would be provided, giving:</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Driver</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
<p>This enables passing extra arguments (e.g. slot configuration, etc.) to the Driver class, that will instantiate the instrument configuration, in the form of a dictionnary.</p>
</div></blockquote>
</li>
<li><p>7) The close function is mandatory, even though you do not use it in any of the other classes of the  <em>&lt;manufacturer&gt;_&lt;MODEL&gt;.py</em> file.</p></li>
</ul>
</div></blockquote>
</div>
<p><strong>Further instrument complexity:</strong></p>
<blockquote>
<div><p>With further instrument and/or connection type complexity you will need to add other arguments to the <code class="docutils literal notranslate"><span class="pre">__init__</span></code> function of Driver_CONNECTION class. As an example to add an argument board_index for a GPIB connection type, you would need to modify the example line 0) to:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="mi">19</span><span class="p">,</span><span class="n">board_index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</pre></div>
</div>
<p>You may also need to pass arguments to the class Driver (see next section), that may come from e.g. the number of channels of an oscilloscope or the consideration of an instrument with <em>slots</em>, you would need to modify line 3) of the example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Driver</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
<p>Please check out autolab existing drivers for more examples and/or to re-use existing connection classes (those would most likely need small adjustments to fit your instruments).</p>
</div></blockquote>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Help for VISA addresses</strong></p>
<p>For <cite>visa</cite> module to work properly, you need to provide an address for communication, that you may be able to get types the few next lines:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">visa</span>
<span class="n">rm</span> <span class="o">=</span> <span class="n">visa</span><span class="o">.</span><span class="n">ResourceManager</span><span class="p">()</span>
<span class="n">rm</span><span class="o">.</span><span class="n">list_resources</span><span class="p">()</span>
</pre></div>
</div>
<p>Just execute them before and after plugging in your instrument to see which address appears. For ethernet connections, you should know the IP address (set it to be part of your local network) and the port (instrument documentation) of your instrument.</p>
<p>Examples of visa addresses may be <a class="reference external" href="https://pyvisa.readthedocs.io/en/latest/">find here online</a> :</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">TCPIP</span><span class="p">::</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">0.5</span><span class="p">::</span><span class="n">INSTR</span>
<span class="n">GPIB0</span><span class="p">::</span><span class="mi">3</span><span class="p">::</span><span class="n">INSTR</span>
</pre></div>
</div>
</div>
</div></blockquote>
</div>
<div class="section" id="class-driver">
<h3>2 -  class Driver<a class="headerlink" href="#class-driver" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>The class Driver: <strong>establish the connection with internal modules or channels</strong> (optionnal as dependant on the instrument, see next section) and <strong>define instrument-related functions</strong>.</p>
<p>After the communication with your instrument is established, we need to send commands or receive answers (to get the results of a query or a requested command). The communication part being manage by the class Driver_CONNECTION, any time we want to send a (instrument-specific) command to the instrument from the class Driver, we need to use the communication functions defined in the class Driver_CONNECTION.</p>
<p>The class Driver_CONNECTION inherits all the attributes of the class Driver. The function <code class="docutils literal notranslate"><span class="pre">__init__</span></code> of the class Driver is run by the class Driver_CONNECTION. The Driver class will act as your main instrument.</p>
<p>Here is a commented example of the class Driver, further explained bellow:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Driver</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>                    <span class="c1"># 1) Definition of the ``__init__`` function</span>
        <span class="kn">import</span> <span class="nn">time</span>                        <span class="c1"># 2) Additional imports and/or setup additional attributes</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;VUNIT MV&#39;</span><span class="p">)</span>             <span class="c1"># 3) Run additional commands to instantiate the instrument (e.g. set the vertical unit to be used)</span>

    <span class="k">def</span> <span class="nf">set_amplitude</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">amplitude</span><span class="p">):</span>     <span class="c1"># 4) Defines a function to set a value to the instrument</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;VOLT {amplitude}&#39;</span><span class="p">)</span>    <span class="c1"># 5) Sets the amplitude, instrument specific</span>
    <span class="k">def</span> <span class="nf">get_amplitude</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>               <span class="c1"># 6) Defines a function to query a value to the instrument</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;VOLT?&#39;</span><span class="p">))</span> <span class="c1"># 7) Returns the amplitude, instrument specific</span>
    <span class="k">def</span> <span class="nf">single_burst</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>                <span class="c1"># 8) Defines a function to perform an action</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;BRST SINGLE&#39;</span><span class="p">)</span>          <span class="c1"># 9) Triggers a single burst, instrument specific</span>

    <span class="k">def</span> <span class="nf">idn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>                         <span class="c1"># 10) This function should work with all instruments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;*IDN?&#39;</span><span class="p">)</span>                <span class="c1"># 11) &#39;*IDN?&#39; should be understood by all instruments</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>                 <span class="c1"># 12) Returns the identification of an instrument</span>
</pre></div>
</div>
<dl>
<dt>When the class Driver_CONNECTION is is instantiated, the <code class="docutils literal notranslate"><span class="pre">__init__</span></code> function is executed. It does the following (following this example labels):</dt><dd><p>1) import additional libraries</p>
<p>2) run additional commands to instantiate the instrument (e.g. set the vertical unit to be used)</p>
</dd>
</dl>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<p>For further instrument complexity, including multi-channels instruments (generators, oscilloscopes, etc.) or instruments with <cite>slots</cite>, the instantiation of additional classes must be done here. See the following examples.</p>
</div>
<p>In general, the <code class="docutils literal notranslate"><span class="pre">__init__</span></code> function should run instrument-related initializations. If nothing in particular needs to be done then, one can just:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">nb_channels</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>       <span class="c1"># 1)</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>Importantly, the class Driver defines all the functions that are related to the main instrument: to set [4)]/query [6)] some values (e.g. the output amplitude of a function generator) or perform actions (e.g. trigger a single burst event).</p>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<p>Several points are worth noting:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Favor python f strings (<code class="docutils literal notranslate"><span class="pre">f''</span></code>) that are more, especially when an argument has to be passed to the function, that are more robust to different types [5)].</p></li>
<li><p>You should explicitely convert the string returned by Driver_CONNEXION.query() (or Driver_CONNEXION.read) to the expected <cite>variable</cite> type [7)].</p></li>
<li><p>For more complex instruments (i.e. with additional classes), please refer to the next section. In general, only the functions associated with the <strong>main</strong> instrument should be found here.</p></li>
</ol>
</div></blockquote>
</div>
<p><strong>Further instrument complexity:</strong></p>
<blockquote>
<div><p>Here is a way to modify the <code class="docutils literal notranslate"><span class="pre">__init__</span></code> function of the class Driver to deal with the case of a <strong>multi-channel instrument</strong>. (Note: some of the lines have been removed from the previous example for clarity.) It is further explained bellow:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">nb_channels</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>       <span class="c1"># 1) Definition of the ``__init__`` function</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">nb_channels</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nb_channels</span><span class="p">)</span> <span class="c1"># 2) Set arguments given to the class as class attributes to be re-used elsewhere (within the class)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nb_channels</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">f</span><span class="s1">&#39;channel{i}&#39;</span><span class="p">,</span><span class="n">Channel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">i</span><span class="p">))</span> <span class="c1"># 3) Set additional Module\_MODEL classes (called Channel here) as classes attibutes</span>
</pre></div>
</div>
<p>Here, the number of channels is provided as argument to the <code class="docutils literal notranslate"><span class="pre">__init__</span></code> function [1)], and for each channel [3)] an attribute of the class Driver is created by instantiating an additional class called <strong>Channel</strong>. The line 3) is formally equivalent to (considering: i=1):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">channel1</span> <span class="o">=</span> <span class="n">Channel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>All the channels are thus equivalent in this example as they use the same additional class (<strong>Channel</strong>). The arguments provided to the class <strong>Channel</strong> are: all the attributes of the actual class (<strong>Driver</strong>) and the number of the instantiated channel; both will be used in the additional class (e.g. the connection functions, etc.)</p>
<p>The previous structure should be used only if the physical slot configuration is naturally fixed by the manufacturer (a power meter with two channels for instance). In the particular case of an <strong>instrument with `slots`</strong>, all the <cite>channels</cite> are not equivalent. They rely on different physical modules that may be disposed differently and in different numbers for different users. Then one class for each different module (that are inserted in a main frame) should be defined (<strong>Module_MODEL</strong>).
Here is a way to modify the <code class="docutils literal notranslate"><span class="pre">__init__</span></code> function of the class Driver to deal with the case of an instrument with <cite>slots</cite>:</p>
<p>This will parse the arguments received by the <code class="docutils literal notranslate"><span class="pre">__init__</span></code> function (of the class <strong>Driver</strong>) in the <code class="docutils literal notranslate"><span class="pre">**kwargs</span></code> appropriately to instantiate the right combination Modules/Slots providing the Modules (additional classes) follow some naming conventions (explained in the next section).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For the particular case of instruments that one usually gets 1 dimensionnal traces from (e.g. oscilloscope, spectrum annalyser, etc.), it is useful to add to the class Driver some user utilities such as procedure for channel acquisitions:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">### User utilities</span>
<span class="k">def</span> <span class="nf">get_data_channels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">channels</span><span class="o">=</span><span class="p">[],</span><span class="n">single</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get all channels or the ones specified&quot;&quot;&quot;</span>
    <span class="n">previous_trigger_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_previous_trigger_state</span><span class="p">()</span>                   <span class="c1"># 1)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>                                                                  <span class="c1"># 2)</span>
    <span class="k">if</span> <span class="n">single</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">single</span><span class="p">()</span>                                                     <span class="c1"># 3)</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_stopped</span><span class="p">():</span> <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>                                <span class="c1"># 4)</span>
    <span class="k">if</span> <span class="n">channels</span> <span class="o">==</span> <span class="p">[]:</span> <span class="n">channels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nb_channels</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">f</span><span class="s1">&#39;channel{i}&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">is_active</span><span class="p">()):</span> <span class="k">continue</span>
        <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">f</span><span class="s1">&#39;channel{i}&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get_data_raw</span><span class="p">()</span>                               <span class="c1"># 5)</span>
        <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">f</span><span class="s1">&#39;channel{i}&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get_log_data</span><span class="p">()</span>                               <span class="c1"># 6)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">set_previous_trigger_state</span><span class="p">(</span><span class="n">previous_trigger_state</span><span class="p">)</span>                      <span class="c1"># 7)</span>

<span class="k">def</span> <span class="nf">save_data_channels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="p">,</span><span class="n">channels</span><span class="o">=</span><span class="p">[],</span><span class="n">FORCE</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">channels</span> <span class="o">==</span> <span class="p">[]:</span> <span class="n">channels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nb_channels</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">:</span>
        <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">f</span><span class="s1">&#39;channel{i}&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">save_data_raw</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span><span class="n">FORCE</span><span class="o">=</span><span class="n">FORCE</span><span class="p">)</span> <span class="c1"># 8)</span>
        <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">f</span><span class="s1">&#39;channel{i}&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">save_log_data</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span><span class="n">FORCE</span><span class="o">=</span><span class="n">FORCE</span><span class="p">)</span> <span class="c1"># 9)</span>
</pre></div>
</div>
<p>These functions rely on some other functions that should be implemented by the user (<code class="docutils literal notranslate"><span class="pre">single</span></code>, <code class="docutils literal notranslate"><span class="pre">get_previous_trigger_state</span></code>, etc.). The reader may find a <a class="reference external" href="https://github.com/qcha41/autolab/tree/master/autolab/drivers/More/Templates">find a full template example here</a>.</p>
<dl class="simple">
<dt>Overall, the function get_data_channels:</dt><dd><ol class="arabic simple">
<li><p>Store the previous trigger state</p></li>
<li><p>Stop the instrument</p></li>
<li><p>Trigger a single trigger event (if requested)</p></li>
<li><p>Wait for the scope to be stopped</p></li>
<li><p>Acquire the channels provided (all if no channel is provided)</p></li>
<li><p>Acquire the logs of the channels provided (all if no channel is provided)</p></li>
<li><p>Set the previous trigger state back</p></li>
</ol>
</dd>
<dt>Overall, the function save_data_channels:</dt><dd><ol class="arabic simple" start="8">
<li><p>Save the channels provided (all if no channel is provided)</p></li>
<li><p>Save the logs of the channels provided (all if no channel is provided)</p></li>
</ol>
</dd>
</dl>
</div>
</div></blockquote>
</div></blockquote>
</div>
<div class="section" id="additional-class-optionnal">
<h3>4 -  Additional class (optionnal)<a class="headerlink" href="#additional-class-optionnal" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><div class="admonition caution">
<p class="admonition-title">Caution</p>
<p><strong>Additional classes namings</strong></p>
<p>The additional classes should be named <strong>Module_MODEL</strong>. Exceptions do occur for some oscilloscopes (<strong>Channel</strong>), spectrum annalyser (<strong>Trace</strong>) or some multi-channel instruments (<strong>Output</strong>), in which case we stick to the way it is refered to as in the Programmer Manual of the associated instrument.</p>
</div>
<p>In the particular case of an <strong>instrument with `slots`</strong>, all the <cite>channels</cite> are not equivalent. They rely on different physical modules that may be disposed differently and in different numbers for different users. Then one class for each different module (that are inserted in a main frame) should be defined (<strong>Module_MODEL</strong>). The <code class="docutils literal notranslate"><span class="pre">__init__</span></code> function of the class <strong>Driver</strong> will deal with which class <strong>Module_MODEL</strong> to instantiate with which <cite>slot</cite> depending on the actual configuration of the user.
Thus the class <strong>Module_MODEL</strong> (or <strong>Channel</strong>, etc.) have all a similar structure, structure that is similar to the one of the class Driver. In other words the class <strong>Driver</strong> deal with the <cite>main</cite> instruments while the additional classes deal with the sub-modules.</p>
<p>Here is an example of the class Channel of a double channel function generator:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Channel</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dev</span><span class="p">,</span><span class="n">channel</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channel</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dev</span>     <span class="o">=</span> <span class="n">dev</span>

    <span class="k">def</span> <span class="nf">amplitude</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">amplitude</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dev</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;:VOLT{self.channel} {amplitude}&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">offset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">offset</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dev</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;:VOLT{self.channel}:OFFS {offset}&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">frequency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">frequency</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dev</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;:FREQ{self.channel} {frequency}&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Here is an example of the two class Module_MODEL of a instrument with <cite>slot</cite> for which slots are non-equivalent (strings needed to perform the same actions are different):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Module_TEST111</span><span class="p">()</span> <span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">driver</span><span class="p">,</span><span class="n">slot</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">driver</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slot</span>   <span class="o">=</span> <span class="n">slot</span>

    <span class="k">def</span> <span class="nf">set_power</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dev</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;POWER={value}&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_power</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dev</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;POWER?&#39;</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">Module_TEST222</span><span class="p">()</span> <span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">driver</span><span class="p">,</span><span class="n">slot</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">driver</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slot</span>   <span class="o">=</span> <span class="n">slot</span>

    <span class="k">def</span> <span class="nf">set_power</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dev</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;POWER={value}&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_power</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dev</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;POWER?&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>One can note (for both cases):</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>In the <code class="docutils literal notranslate"><span class="pre">__init__</span></code> function both the driver <code class="docutils literal notranslate"><span class="pre">self</span></code> and the channel/slot naming are passed to an attribute of the actual class (<strong>Channel</strong>, <strong>Module_TEST111</strong>, <strong>Module_TEST222</strong>).</p></li>
<li><p>The connection functions used are the one coming from the class <strong>Driver</strong>, thus one now call them <code class="docutils literal notranslate"><span class="pre">self.dev.connection_function</span></code> (for connection_function defined in the class <strong>Driver_CONNECTION</strong> in: write, read, query, etc.).</p></li>
<li><p>Finally there is a collection of functions that are <cite>channel</cite>/<cite>slot</cite>-dependant.</p></li>
</ol>
</div></blockquote>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For the particular case of instruments that one usually gets 1 dimensionnal traces from (e.g. oscilloscope, spectrum annalyser, etc.), it is useful to define functions to get and save the data. See the folliwing instrument dependant example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_data_raw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">autoscale</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_autoscale</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dev</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;C{self.channel}:WF? DAT1&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">data_raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dev</span><span class="o">.</span><span class="n">read_raw</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">data_raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_raw</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data_raw</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;#&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">11</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_raw</span>
<span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">frombuffer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_data_raw</span><span class="p">(),</span><span class="n">int8</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_log_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">log_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dev</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;C{self.channel}:INSP? &#39;WAVEDESC&#39;&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_data</span>

<span class="k">def</span> <span class="nf">save_data_raw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="p">,</span><span class="n">FORCE</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="n">temp_filename</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;{filename}_WAVEMASTERCH{self.channel}&#39;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span><span class="n">temp_filename</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span><span class="p">(</span><span class="n">FORCE</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">File &#39;</span><span class="p">,</span> <span class="n">temp_filename</span><span class="p">,</span> <span class="s1">&#39; already exists, change filename or remove old file</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">temp_filename</span><span class="p">,</span><span class="s1">&#39;wb&#39;</span><span class="p">)</span><span class="c1"># Save data</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_raw</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">save_log_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="p">,</span><span class="n">FORCE</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="n">temp_filename</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;{filename}_WAVEMASTERCH{self.channel}.log&#39;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span><span class="n">temp_filename</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span><span class="p">(</span><span class="n">FORCE</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">File &#39;</span><span class="p">,</span> <span class="n">temp_filename</span><span class="p">,</span> <span class="s1">&#39; already exists, change filename or remove old file</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">temp_filename</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_data</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p>Those will then be attributes of the class <strong>Channel</strong> and may be called from the class <strong>Driver</strong> (depending on the channel’s instance name in this class):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">channel1</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div></blockquote>
</div>
</div>
<div class="section" id="additional-necessary-functions-files">
<h2>Additional necessary functions/files<a class="headerlink" href="#additional-necessary-functions-files" title="Permalink to this headline">¶</a></h2>
<div class="section" id="function-get-driver-model-in-each-class-but-driver-connection">
<h3>Function get_driver_model (in each class but Driver_CONNECTION)<a class="headerlink" href="#function-get-driver-model-in-each-class-but-driver-connection" title="Permalink to this headline">¶</a></h3>
<p>The function <code class="docutils literal notranslate"><span class="pre">get_driver_model</span></code> should be present in each of the classes of the <em>&lt;manufacturer&gt;_&lt;MODEL&gt;.py</em> but the class <strong>Driver_CONNECTION</strong> (including the class Driver and any optionnal class <strong>Module_MODEL</strong>), in order for many features of the package to work properly. It simply consists in a list of predefined elements that will indicate to the package the structure of the driver and predefined variable and actions.
There are three possible elements in the function <code class="docutils literal notranslate"><span class="pre">get_driver_model</span></code>: <em>Module</em>, <em>Variable</em> and <em>Action</em>.</p>
<dl>
<dt>Shared by the three elements (<em>Module</em>, <em>Variable</em>, <em>Action</em>):</dt><dd><ul class="simple">
<li><p>‘name’: nickname for your element (argument type: string)</p></li>
<li><p>‘element’: element type, exclusively in: ‘module’, ‘variable’, ‘action’ (argument type: string)</p></li>
<li><p>‘help’: quick help, optionnal (argument type: string)</p></li>
</ul>
</dd>
<dt><em>Module</em>:</dt><dd><ul class="simple">
<li><p>‘object’ : attribute of the class (argument type: Instance)</p></li>
</ul>
</dd>
<dt><em>Variable</em>:</dt><dd><ul class="simple">
<li><p>‘read’: class attribute (argument type: function)</p></li>
<li><p>‘write’: class attribute (argument type: function)</p></li>
<li><p>‘type’: python type, exclusively in: int, float, bool, str, bytes, np.ndarray, pd.DataFrame</p></li>
<li><p>‘unit’: unit of the variable, optionnal (argument type: string)</p></li>
</ul>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<p>Either ‘read’ or ‘write’ key, or both of them, must be provided.</p>
</div>
</dd>
<dt><em>Action</em>:</dt><dd><ul class="simple">
<li><p>‘do’ : class attribute</p></li>
</ul>
</dd>
</dl>
<p>Example code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_driver_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">model</span> <span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="s1">&#39;line1&#39;</span><span class="p">,</span> <span class="s1">&#39;element&#39;</span><span class="p">:</span><span class="s1">&#39;module&#39;</span><span class="p">,</span><span class="s1">&#39;object&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">slot1</span><span class="p">,</span><span class="s1">&#39;help&#39;</span><span class="p">:</span><span class="s1">&#39;Simple help for line1 module&#39;</span><span class="p">})</span>
    <span class="n">model</span> <span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="s1">&#39;amplitude&#39;</span><span class="p">,</span> <span class="s1">&#39;element&#39;</span><span class="p">:</span><span class="s1">&#39;variable&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="nb">float</span><span class="p">,</span> <span class="s1">&#39;read&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">get_amplitude</span><span class="p">,</span> <span class="s1">&#39;write&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">set_amplitude</span><span class="p">,</span> <span class="s1">&#39;unit&#39;</span><span class="p">:</span><span class="s1">&#39;V&#39;</span><span class="p">,</span> <span class="s1">&#39;help&#39;</span><span class="p">:</span><span class="s1">&#39;Simple help for amplitude variable&#39;</span><span class="p">}</span>
    <span class="n">model</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="s1">&#39;go_home&#39;</span><span class="p">,</span> <span class="s1">&#39;element&#39;</span><span class="p">:</span><span class="s1">&#39;action&#39;</span><span class="p">,</span> <span class="s1">&#39;read&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">home</span><span class="p">,</span> <span class="s1">&#39;help&#39;</span><span class="p">:</span><span class="s1">&#39;Simple help for go_home action&#39;</span><span class="p">})</span>
<span class="k">return</span> <span class="n">model</span>
</pre></div>
</div>
</div>
<div class="section" id="driver-utilities-structure-manufacturer-model-utilities-py-file">
<h3>Driver utilities structure (<em>&lt;manufacturer&gt;_&lt;MODEL&gt;_utilities.py</em> file)<a class="headerlink" href="#driver-utilities-structure-manufacturer-model-utilities-py-file" title="Permalink to this headline">¶</a></h3>
<p>This file should be present in the driver directory (<em>&lt;manufacturer&gt;_&lt;MODEL&gt;.py</em>).</p>
<p>Here is a commented example of the file <em>&lt;manufacturer&gt;_&lt;MODEL&gt;_utilities.py</em>, further explained bellow:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">category</span> <span class="o">=</span> <span class="s1">&#39;Optical source&#39;</span>                                <span class="c1">#</span>

<span class="k">class</span> <span class="nc">Driver_parser</span><span class="p">():</span>                                     <span class="c1">#</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Instance</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>          <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span>     <span class="o">=</span> <span class="n">name</span>                               <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Instance</span> <span class="o">=</span> <span class="n">Instance</span>                           <span class="c1">#</span>


    <span class="k">def</span> <span class="nf">add_parser_usage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">message</span><span class="p">):</span>                    <span class="c1">#</span>
        <span class="sd">&quot;&quot;&quot;Usage to be used by the parser&quot;&quot;&quot;</span>               <span class="c1">#</span>
        <span class="n">usage</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;&quot;&quot;                                       #</span>
<span class="s2">{message}                                                  #</span>
<span class="s2">                                                           #</span>
<span class="s2">----------------  Examples:  ----------------              #</span>
<span class="s2">                                                           #</span>
<span class="s2">usage:    autolab driver [options] args                    #</span>
<span class="s2">                                                           #</span>
<span class="s2">    autolab driver -D {self.name} -A GPIB0::2::INSTR -C VISA -a 0.2</span>
<span class="s2">    load {self.name} driver using VISA communication protocol with address GPIB... and set the laser pump current to 200mA.</span>
<span class="s2">                                                           #</span>
<span class="s2">    autolab driver -D nickname -a 0.2</span>
<span class="s2">    Similar to previous one but using the device&#39;s nickname as defined in local_config.ini</span>
<span class="s2">            &quot;&quot;&quot;</span>                                            <span class="c1">#</span>
        <span class="k">return</span> <span class="n">usage</span>                                       <span class="c1">#</span>

    <span class="k">def</span> <span class="nf">add_parser_arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">parser</span><span class="p">):</span>                 <span class="c1">#</span>
        <span class="sd">&quot;&quot;&quot;Add arguments to the parser passed as input&quot;&quot;&quot;</span>  <span class="c1">#</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-a&quot;</span><span class="p">,</span> <span class="s2">&quot;--amplitude&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;amplitude&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Set the pump current value in Ampere.&quot;</span> <span class="p">)</span>

        <span class="k">return</span> <span class="n">parser</span>                                      <span class="c1">#</span>

    <span class="k">def</span> <span class="nf">do_something</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">args</span><span class="p">):</span>                           <span class="c1">#</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">amplitude</span><span class="p">:</span>                                 <span class="c1">#</span>
            <span class="c1"># next line equivalent to: self.Instance.amplitude = args.amplitude</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Instance</span><span class="p">,</span><span class="s1">&#39;amplitude&#39;</span><span class="p">)(</span><span class="n">args</span><span class="o">.</span><span class="n">amplitude</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">exit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>                                        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Instance</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>                              <span class="c1">#</span>
</pre></div>
</div>
<p>It contains:</p>
<blockquote>
<div><ul>
<li><p>The category of the instrument (see <code class="docutils literal notranslate"><span class="pre">autolab.infos</span></code> (from python shell) or <code class="docutils literal notranslate"><span class="pre">autolab</span> <span class="pre">infos</span></code> for (OS shell) for examples of identified categories).</p></li>
<li><p>A class <strong>Driver_parser</strong> with 5 functions:</p>
<blockquote>
<div><p><strong>1</strong>) <code class="docutils literal notranslate"><span class="pre">__init__</span></code>: defines class attributes</p>
<p><strong>2</strong>) <code class="docutils literal notranslate"><span class="pre">add_parser_usage</span></code>: adds help to the parser in oorder to help the user</p>
<p><strong>3</strong>) <code class="docutils literal notranslate"><span class="pre">add_parser_arguments</span></code>: configures options to be used from the OS shell (e.g. <code class="docutils literal notranslate"><span class="pre">autolab</span> <span class="pre">driver</span> <span class="pre">-D</span> <span class="pre">nickname</span> <span class="pre">-a</span> <span class="pre">2</span></code>). See <a class="reference internal" href="../shell/driver.html#os-driver"><span class="std std-ref">Command driver</span></a> for full usage.</p>
<p><strong>4</strong>) <code class="docutils literal notranslate"><span class="pre">do_something</span></code>: configures action to perform/variable to set (here: modify the amplitude to the the provided argument value), and link them to the values of the argument added with <strong>3</strong>.</p>
<p><strong>5</strong>) <code class="docutils literal notranslate"><span class="pre">exit</span></code>: closes properly the connection</p>
</div></blockquote>
</li>
</ul>
</div></blockquote>
<p>Please do consider, keeping each line ending with a # character in the example as is.This way you need to modify 3 main parts to configure options, associated actions and help:  <strong>3</strong>, <strong>4</strong> and <strong>2</strong> (respectively).</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../high_level.html" class="btn btn-neutral float-right" title="Devices (High-level interface)" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="open_and_use.html" class="btn btn-neutral float-left" title="Load and use a Driver" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Quentin Chateiller, Bruno Garbin

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>